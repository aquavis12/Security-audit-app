<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecAuditTool - Security Checks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --sudo-primary: #1a1a2e;
            --sudo-accent: #0f3460;
            --sudo-highlight: #16c784;
            --sudo-warning: #ff6b6b;
            --sudo-info: #4ecdc4;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--sudo-primary) 0%, var(--sudo-accent) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: white;
        }

        .header p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
        }





        .content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .audit-form {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .form-section {
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 30px;
        }

        .form-section:last-of-type {
            border-bottom: none;
        }

        .form-section h2 {
            color: var(--sudo-primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #42A5F5;
            box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.1);
        }

        .checks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .check-actions {
            display: flex;
            gap: 15px;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--sudo-info);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
        }

        .btn-link:hover {
            color: var(--sudo-highlight);
        }

        .checks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .check-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .check-item:hover {
            border-color: var(--sudo-info);
            background: #f5f5f5;
        }

        .check-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .region-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s;
            margin-top: 8px;
        }

        .region-dropdown:hover:not(:disabled) {
            border-color: #1565C0;
        }

        .region-dropdown:focus {
            outline: none;
            border-color: #1565C0;
            box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
        }

        .region-dropdown:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .region-info {
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 10px;
            background-color: rgba(22, 199, 132, 0.1);
            border-left: 4px solid var(--sudo-highlight);
            border-radius: 4px;
        }

        .selected-regions {
            margin-top: 15px;
            padding: 12px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }

        .region-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .region-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: var(--sudo-info);
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .remove-region {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            line-height: 1;
            transition: opacity 0.2s;
        }

        .remove-region:hover {
            opacity: 0.7;
        }

        .check-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .check-name {
            font-weight: 500;
            color: #333;
        }

        .check-severity {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c62828;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--sudo-highlight), var(--sudo-info));
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(22, 199, 132, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--sudo-info);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: var(--sudo-highlight);
            box-shadow: 0 4px 12px rgba(22, 199, 132, 0.3);
        }

        .results {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #f0f0f0;
            display: none;
        }

        .results.show {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .results-header h2 {
            color: var(--sudo-primary);
            font-size: 1.8rem;
            font-weight: 600;
        }

        .results-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .s3-info {
            font-size: 0.85rem;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-card {
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .summary-card.critical {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        }

        .summary-card.high {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
        }

        .summary-card.medium {
            background: linear-gradient(135deg, #fbc02d 0%, #f57f17 100%);
        }

        .summary-card.low {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
        }

        .card-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .findings-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .finding-item {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: border-color 0.3s;
        }

        .finding-item:hover {
            border-color: var(--sudo-info);
        }

        .finding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .finding-header h3 {
            color: #333;
            font-size: 1.2rem;
            text-transform: capitalize;
        }

        .finding-count {
            background: var(--sudo-info);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .finding-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #555;
            font-family: 'Courier New', monospace;
        }

        .item-more {
            padding: 10px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 40px;
            padding: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--sudo-info);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .checks-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 style="margin: 0;">üõ°Ô∏è SecAuditTool</h1>
                <div style="display: flex; gap: 15px;">
                    <a href="/audit-modes" style="background: linear-gradient(135deg, #16c784 0%, #00d4aa 100%); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; box-shadow: 0 4px 15px rgba(22, 199, 132, 0.3);">
                        üîß Select Audit Mode
                    </a>
                    <a href="/dashboard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        üìä View Dashboard
                    </a>
                </div>
            </div>
            <p>Comprehensive security assessment for your AWS environment</p>
            <div style="margin-top: 20px; padding: 15px; background: rgba(22, 199, 132, 0.1); border-radius: 8px; border-left: 4px solid #16c784;">
                <p style="margin: 0; color: #1a1a2e; font-weight: 600;">
                    ‚ú® New: Choose between Security Checks mode or Compliance Audit mode (AWS Audit Manager integration)
                </p>
            </div>
        </header>

        <div class="content">
            <form id="auditForm" class="audit-form">
                <div class="form-section">
                    <h2>AWS Account Configuration</h2>
                    <div style="margin-bottom: 20px; padding: 12px; background-color: rgba(22, 199, 132, 0.1); border-left: 4px solid var(--sudo-highlight); border-radius: 4px;">
                        <small style="color: #333; font-size: 0.9rem;">
                            <i class="fas fa-info-circle" style="color: var(--sudo-highlight); margin-right: 8px;"></i>
                            <strong>Cross-Account Role Assumption:</strong> This tool uses IAM role assumption only. No AWS credentials are stored or required.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>AWS Regions (Max 3) *</label>
                        <div class="region-info">
                            <small style="color: #1565C0; font-size: 0.9rem; font-weight: 500;">
                                üí° Tip: Auditing 1 region at a time is faster. Max 3 regions per audit.
                            </small>
                        </div>
                        
                        <select id="regionSelect" class="region-dropdown">
                            <option value="">Select a region...</option>
                        </select>

                        <div id="selectedRegionsContainer" class="selected-regions" style="display: none;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                                Selected Regions (<span id="regionCount">0</span>/3):
                            </label>
                            <div id="regionTags" class="region-tags"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>AWS Account ID *</label>
                        <input type="text" id="accountId" name="accountId" placeholder="123456789012" pattern="[0-9]{12}" required>
                    </div>

                    <div class="form-group">
                        <label>IAM Role Name *</label>
                        <input type="text" id="roleName" name="roleName" placeholder="SecurityAuditRole" required>
                    </div>

                    <div class="form-group">
                        <label>External ID *</label>
                        <input type="text" id="externalId" name="externalId" placeholder="Required for cross-account security" required>
                        <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                            ‚ö†Ô∏è External ID is mandatory to prevent confused deputy attacks
                        </small>
                    </div>



                </div>

                <div class="form-section">
                    <div class="checks-header">
                        <div>
                            <h2>Security Checks</h2>
                            <small id="checksCount" style="color: #666; font-size: 0.9rem;"></small>
                        </div>
                        <div class="check-actions">
                            <button type="button" id="selectAllBtn" class="btn-link">Select All</button>
                            <button type="button" id="deselectAllBtn" class="btn-link">Deselect All</button>
                        </div>
                    </div>

                    <div id="checksGrid" class="checks-grid"></div>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>

                <button type="submit" id="submitBtn" class="btn-primary">Run Security Audit</button>
            </form>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Running audit... This may take a few minutes.</p>
            </div>

            <div id="results" class="results">
                <div class="results-header">
                    <h2>Audit Results</h2>
                    <div class="results-actions">
                        <button id="downloadBtn" class="btn-secondary">üìÑ Download PDF Report</button>
                        <div id="s3Info" class="s3-info"></div>
                    </div>
                </div>

                <div id="summaryCards" class="summary-cards"></div>
                <div id="findingsList" class="findings-list"></div>
            </div>
        </div>

        <footer class="footer">
            <p>AWS Security Audit Tool </p>
        </footer>
    </div>

    <script>
        const API_URL = '';
        const availableRegions = [
            'us-east-1', 'us-east-2', 'us-west-1', 'us-west-2',
            'eu-west-1', 'eu-west-2', 'eu-west-3', 'eu-central-1', 'eu-north-1',
            'ap-southeast-1', 'ap-southeast-2', 'ap-northeast-1', 'ap-northeast-2', 'ap-northeast-3',
            'ap-south-1', 'ca-central-1', 'sa-east-1', 'me-south-1', 'af-south-1'
        ];

        let selectedRegions = [];
        let availableChecks = [];
        let selectedChecks = [];
        let currentResults = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeRegionSelect();
            fetchAvailableChecks();
            setupEventListeners();
        });

        function initializeRegionSelect() {
            const select = document.getElementById('regionSelect');
            availableRegions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                select.appendChild(option);
            });
        }

        async function fetchAvailableChecks() {
            try {
                const response = await fetch(`${API_URL}/api/checks`);
                const data = await response.json();
                
                // Flatten categorized checks into single array
                availableChecks = [];
                Object.keys(data.checks).forEach(category => {
                    data.checks[category].forEach(check => {
                        availableChecks.push({...check, category});
                    });
                });
                
                selectedChecks = availableChecks.map(c => c.id);
                renderChecks();
            } catch (err) {
                console.error('Failed to fetch checks:', err);
            }
        }

        function renderChecks() {
            const grid = document.getElementById('checksGrid');
            grid.innerHTML = '';
            
            // Show all checks
            let checksToShow = availableChecks;
            
            // Update checks count display
            const checksCountEl = document.getElementById('checksCount');
            checksCountEl.textContent = `Showing all ${checksToShow.length} checks`;
            checksCountEl.style.color = '#666';
            checksCountEl.style.fontWeight = 'normal';
            
            // Group checks by category
            const categories = {};
            checksToShow.forEach(check => {
                if (!categories[check.category]) {
                    categories[check.category] = [];
                }
                categories[check.category].push(check);
            });
            
            // Render each category
            Object.keys(categories).forEach(category => {
                // Category header
                const categoryHeader = document.createElement('div');
                categoryHeader.style.cssText = 'grid-column: 1 / -1; margin-top: 20px; margin-bottom: 10px;';
                categoryHeader.innerHTML = `
                    <h3 style="color: var(--sudo-primary); font-size: 1.1rem; font-weight: 600; border-bottom: 2px solid rgba(22, 199, 132, 0.2); padding-bottom: 8px;">
                        ${category}
                    </h3>
                `;
                grid.appendChild(categoryHeader);
                
                // Category checks
                categories[category].forEach(check => {
                    const label = document.createElement('label');
                    label.className = 'check-item';
                    
                    label.innerHTML = `
                        <input type="checkbox" value="${check.id}" ${selectedChecks.includes(check.id) ? 'checked' : ''}>
                        <div class="check-content">
                            <div>
                                <span class="check-name">${check.name}</span>
                            </div>
                            <span class="check-severity" style="color: ${getSeverityColor(check.severity)}">${check.severity}</span>
                        </div>
                    `;
                    label.querySelector('input').addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedChecks.push(check.id);
                        } else {
                            selectedChecks = selectedChecks.filter(id => id !== check.id);
                        }
                    });
                    grid.appendChild(label);
                });
            });
        }

        function getSeverityColor(severity) {
            const colors = {
                'Critical': '#d32f2f',
                'High': '#f57c00',
                'Medium': '#fbc02d',
                'Low': '#388e3c'
            };
            return colors[severity] || '#666';
        }

        function setupEventListeners() {
            document.getElementById('regionSelect').addEventListener('change', handleRegionChange);
            document.getElementById('selectAllBtn').addEventListener('click', handleSelectAll);
            document.getElementById('deselectAllBtn').addEventListener('click', handleDeselectAll);
            document.getElementById('auditForm').addEventListener('submit', handleSubmit);
            document.getElementById('downloadBtn').addEventListener('click', downloadPDF);
        }
        


        function handleRegionChange(e) {
            const region = e.target.value;
            if (region && !selectedRegions.includes(region)) {
                if (selectedRegions.length < 3) {
                    selectedRegions.push(region);
                    updateRegionDisplay();
                }
            }
            e.target.value = '';
        }

        function removeRegion(region) {
            selectedRegions = selectedRegions.filter(r => r !== region);
            updateRegionDisplay();
        }

        function updateRegionDisplay() {
            const container = document.getElementById('selectedRegionsContainer');
            const tags = document.getElementById('regionTags');
            const count = document.getElementById('regionCount');

            if (selectedRegions.length === 0) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                count.textContent = selectedRegions.length;
                tags.innerHTML = selectedRegions.map(region => `
                    <div class="region-tag">
                        <span>${region}</span>
                        <button type="button" class="remove-region" onclick="removeRegion('${region}')">‚úï</button>
                    </div>
                `).join('');
            }

            const select = document.getElementById('regionSelect');
            select.disabled = selectedRegions.length >= 3;
        }

        function handleSelectAll(e) {
            e.preventDefault();
            selectedChecks = availableChecks.map(c => c.id);
            renderChecks();
        }

        function handleDeselectAll(e) {
            e.preventDefault();
            selectedChecks = [];
            renderChecks();
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';

            if (selectedRegions.length === 0) {
                errorDiv.textContent = '‚ö†Ô∏è Please select at least one region';
                errorDiv.style.display = 'block';
                return;
            }

            if (selectedChecks.length === 0) {
                errorDiv.textContent = '‚ö†Ô∏è Please select at least one check';
                errorDiv.style.display = 'block';
                return;
            }

            const formData = {
                accountId: document.getElementById('accountId').value,
                roleName: document.getElementById('roleName').value,
                externalId: document.getElementById('externalId').value,
                regions: selectedRegions,
                selectedChecks: selectedChecks
            };

            document.getElementById('loading').classList.add('show');
            document.getElementById('submitBtn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/audit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Audit failed');
                }

                currentResults = data;
                displayResults(data);
            } catch (err) {
                errorDiv.textContent = `‚ö†Ô∏è ${err.message}`;
                errorDiv.style.display = 'block';
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('submitBtn').disabled = false;
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const summaryCards = document.getElementById('summaryCards');
            const findingsList = document.getElementById('findingsList');
            const s3Info = document.getElementById('s3Info');

            // Summary cards
            summaryCards.innerHTML = `
                <div class="summary-card critical">
                    <div class="card-value">${data.summary.critical}</div>
                    <div class="card-label">Critical</div>
                </div>
                <div class="summary-card high">
                    <div class="card-value">${data.summary.high}</div>
                    <div class="card-label">High</div>
                </div>
                <div class="summary-card medium">
                    <div class="card-value">${data.summary.medium}</div>
                    <div class="card-label">Medium</div>
                </div>
                <div class="summary-card low">
                    <div class="card-value">${data.summary.low}</div>
                    <div class="card-label">Low</div>
                </div>
            `;

            // Findings
            findingsList.innerHTML = data.findings.map((finding, idx) => `
                <div class="finding-item">
                    <div class="finding-header">
                        <h3>${finding.check.replace(/_/g, ' ')}</h3>
                        <span class="finding-count">${finding.count} issues</span>
                    </div>
                    <div class="finding-items">
                        ${finding.items.slice(0, 5).map(item => `
                            <div class="item">${typeof item === 'string' ? item : JSON.stringify(item).substring(0, 100)}</div>
                        `).join('')}
                        ${finding.count > 5 ? `<div class="item-more">... and ${finding.count - 5} more</div>` : ''}
                    </div>
                </div>
            `).join('');

            // S3 info
            if (data.report) {
                s3Info.innerHTML = `<small style="color: #666;">üì¶ Stored in customer's S3: ${data.report.s3_bucket}</small>`;
            }

            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadPDF() {
            if (currentResults?.report?.presigned_url) {
                window.open(currentResults.report.presigned_url, '_blank');
            } else {
                alert('PDF report URL not available');
            }
        }
    </script>
</body>
</html>
